<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okul Yurt Rehberi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 40px 15px; font-family: 'Segoe UI', sans-serif; }
        .yurt-kart-sarmalayÄ±cÄ± { display: flex; justify-content: center; width: 100%; margin-bottom: 30px; }
        .card { 
            border: none; border-radius: 20px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 950px; background: #fff;
        }
        .harita-konteyner { width: 100%; height: 100%; min-height: 300px; background-color: #eee; }
        iframe { width: 100%; height: 100%; border: 0; min-height: 300px; }
        .badge-tel { background-color: #f0f7ff; color: #007bff; padding: 10px 15px; border-radius: 10px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-dark">ğŸ  Yurt Rehberi</h1>
        <p class="text-muted">Okulunuzu seÃ§in, size en uygun yurtlarÄ± listeleyelim.</p>
    </div>
    
    <div class="row justify-content-center mb-5">
        <div class="col-md-6">
            <div class="card p-4 shadow-sm text-center">
                <label class="form-label fw-bold text-secondary mb-3">Okulunuzu SeÃ§in</label>
                <select id="okulSecimi" class="form-select form-select-lg" onchange="yurtlariListele()">
                    <option value="">Veriler yÃ¼kleniyor...</option>
                </select>
            </div>
        </div>
    </div>
	<div id="okulDetayAlani" class="row justify-content-center mb-4"></div>
    <div id="yurtListesi" class="row"></div>
</div>

<script>
    let GLOBAL_DATA = null;
    const API_URL = "https://script.google.com/macros/s/AKfycbysknNUaemUa-JyPzGRw35-EabXgmZ0oS7D9YjGNkX-DkPzJD-C_8l1VceTNZK2SOk/exec";

    window.onload = function() {
        console.log("1. Veri Ã§ekme baÅŸladÄ±...");
        fetch(API_URL + "?action=getOkullar", { redirect: 'follow' })
            .then(res => res.json())
            .then(data => {
                console.log("2. Veri baÅŸarÄ±yla alÄ±ndÄ±:", data);
                GLOBAL_DATA = data;
                verileriDoldur(data);
            })
            .catch(err => console.error("Hata:", err));
    };

    function verileriDoldur(data) {
        const select = document.getElementById("okulSecimi");
        select.innerHTML = '';
        
        data.okulListesi.forEach((okul, index) => {
            if(okul[0] && okul[1]) {
                let opt = document.createElement("option");
                opt.value = okul[0].toString().trim();
                opt.text = okul[1].toString().trim();
                select.appendChild(opt);
            }
        });
        console.log("3. Dropdown dolduruldu.");
    }

    function yurtlariListele() {
        const secilenOkulID = document.getElementById("okulSecimi").value;
        console.log("Filtreleme baÅŸlatÄ±ldÄ±. Aranan ID:", secilenOkulID);
		if (!secilenOkulID) return;
        const listeDiv = document.getElementById("yurtListesi");
        listeDiv.innerHTML = "SeÃ§ilen okula ait yurtlar getiriliyor...";
		
		const okulDetayDiv = document.getElementById("okulDetayAlani");
		okulDetayDiv.innerHTML = "";
		
        if (!secilenOkulID || !GLOBAL_DATA) return;
		const okulVerisi = GLOBAL_DATA.okulListesi.find(o => o[0].toString().trim() === secilenOkulID);
    
		if (okulVerisi) {
			const okulAd = okulVerisi[1];
			const okulHarita = okulVerisi[2];
			const okulAdres = okulVerisi[3];
			const okulEmbed = `https://maps.google.com/maps?q=${encodeURIComponent(okulAd + " " + okulAdres)}&t=&z=14&ie=UTF8&iwloc=&output=embed`;

			okulDetayDiv.innerHTML = `
				<div class="col-md-10 col-lg-8">
					<div class="card shadow-sm border-primary mb-4" style="border-left: 5px solid #007bff;">
						<div class="card-body">
							<h4 class="fw-bold text-primary">ğŸ« ${okulAd}</h4>
							<p class="small text-muted mb-2">ğŸ“ ${okulAdres}</p>
							<div style="height: 200px; border-radius: 10px; overflow: hidden;">
								<iframe src="${okulEmbed}" width="100%" height="100%"></iframe>
							</div>
						</div>
					</div>
					<h5 class="text-center mb-4 fw-bold">ğŸ‘‡ YakÄ±ndaki Yurtlar</h5>
				</div>`;
		}
		
		// Sunucuya "Bana sadece bu okulun yurtlarÄ±nÄ± getir" diyoruz
		fetch(API_URL + `?action=getYurtlar&okulID=${secilenOkulID}`, { redirect: 'follow' })
			.then(res => res.json())
			.then(data => {
				// Gelen veriyi (data.yurtListesi) dÃ¶ngÃ¼ye sokup ekrana bas
				yurtlariEkranaBas(data.yurtListesi); 
			});
        
    }
	function yurtlariListele(yurtListesiData) {
		const listeDiv = document.getElementById("yurtListesi");
		// EÄŸer liste boÅŸsa veya sadece baÅŸlÄ±ktan ibaretse (Google'dan veri dÃ¶nmediyse)
		if (!yurtListesiData || yurtListesiData.length < 2) {
			listeDiv.innerHTML = `
				<div class="col-12 text-center mt-5">
					<div class="p-5 border rounded-3 bg-light shadow-sm">
						<h1 class="display-1">ğŸ”</h1>
						<h4 class="fw-bold text-secondary">Bu Okula Ait Yurt BulunamadÄ±</h4>
						<p class="text-muted">Åu an iÃ§in bu Ã¼niversiteye kayÄ±tlÄ± bir yurt verisi bulunmuyor.</p>
					</div>
				</div>`;
			return;
		}
		
		for (let i = 1; i < yurtListesiData.length; i++) {
			console.log("EÅŸleÅŸme bulundu:", yurt[1]);			
			const yurtAd = yurt[1];
			const haritaLink = yurt[2];
			const adres = yurt[3];
			const sorumlu = yurt[4];
			const telefon = yurt[5];
			
			const embedUrl = `https://maps.google.com/maps?q=${encodeURIComponent(yurtAd + " " + adres)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;

			const html = `
				<div class="col-12 yurt-kart-sarmalayÄ±cÄ±">
					<div class="card shadow">
						<div class="row g-0">
							<div class="col-md-5">
								<div class="harita-konteyner">
									<iframe src="${embedUrl}" allowfullscreen></iframe>
								</div>
							</div>
							<div class="col-md-7 d-flex align-items-center">
								<div class="card-body p-4 p-lg-5">
									<h3 class="fw-bold mb-3">${yurtAd}</h3>
									<div class="mb-4">
										<p class="mb-2 text-muted"><strong>ğŸ“ Adres:</strong> ${adres}</p>
										<p class="mb-2 text-muted"><strong>ğŸ‘¤ Sorumlu:</strong> ${sorumlu}</p>
									</div>
									<div class="d-flex gap-2">
										<a href="tel:${telefon.toString().replace(/\s/g, '')}" class="btn btn-success btn-lg px-4 shadow-sm">ğŸ“ ${telefon}</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>`;
			listeDiv.innerHTML += html;
        }
	}
</script>

</body>
</html>