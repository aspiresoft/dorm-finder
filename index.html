<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okul Yurt Rehberi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f7f6;
            padding: 40px 15px;
            font-family: 'Segoe UI', sans-serif;
        }

        .yurt-kart-sarmalayici {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 30px;
        }

        .card {
            border: none;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            background: #fff;
        }

        .harita-konteyner iframe {
            width: 100%;
            height: 100%;
            border: 0;
            min-height: 300px;
        }

        .badge-tel {
            background-color: #f0f7ff;
            color: #007bff;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 1rem;
        }

        .strong-shadow {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Ba≈ülƒ±k B√∂l√ºm√º -->
        <div class="text-center mb-5">
            <h1 class="fw-bold text-dark">üè† Yurt Rehberi</h1>
            <p class="text-muted">Okulunuzu se√ßin, size en uygun yurtlarƒ± listeleyelim.</p>
        </div>

        <!-- Okul Se√ßim B√∂l√ºm√º -->
        <div class="row justify-content-center mb-5">
            <div class="col-md-6">
                <div class="card p-4 shadow-sm text-center">
                    <label class="form-label fw-bold text-secondary mb-3">Okulunuzu Se√ßin</label>
                    <select id="okulSecimi" class="form-select form-select-lg" onchange="OkulYurtApp.yurtlariListele()">
                        <option value="">Veriler y√ºkleniyor...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Okul Detay B√∂l√ºm√º -->
        <div id="okulDetayAlani" class="row justify-content-center mb-4"></div>

        <!-- Yurt Listesi B√∂l√ºm√º -->
        <div id="yurtListesi" class="row"></div>
    </div>

    <script>
        /**
         * Ana Uygulama Mod√ºl√º
         * T√ºm uygulama mantƒ±ƒüƒ±nƒ± i√ßeren singleton pattern
         */
        const OkulYurtApp = (function () {
            // ==================== YAPILANDIRMA ====================
            const CONFIG = {
                API_URL: "https://script.google.com/macros/s/AKfycbyYoh4gLSi9MyrWJkHc7rEdgkKAHFAVUkCgXrfi0ZVVXUinM9knIFtBaKoXBd0N0VA/exec",
                CACHE_KEY: "OKUL_YURT_DATA_V1",
                CACHE_TTL: 5 * 60 * 1000, // 5 dakika
                SELECTORS: {
                    okulSecimi: "okulSecimi",
                    okulDetay: "okulDetayAlani",
                    yurtListesi: "yurtListesi"
                }
            };

            // ==================== STATE ====================
            let globalData = null;

            // ==================== CACHE Y√ñNETƒ∞Mƒ∞ ====================
            const CacheManager = {
                /**
                 * Cache'den veri okur
                 * @returns {Object|null} Cache'deki veri veya null
                 */
                load() {
                    try {
                        const raw = localStorage.getItem(CONFIG.CACHE_KEY);
                        if (!raw) return null;

                        const parsed = JSON.parse(raw);
                        const isExpired = Date.now() - parsed.timestamp > CONFIG.CACHE_TTL;

                        if (isExpired) {
                            console.log("Cache s√ºresi dolmu≈ü, temizleniyor");
                            this.clear();
                            return null;
                        }

                        console.log("Cache ba≈üarƒ±yla y√ºklendi");
                        return parsed.data;
                    } catch (error) {
                        console.error("Cache okuma hatasƒ±:", error);
                        return null;
                    }
                },

                /**
                 * Veriyi cache'e kaydeder
                 * @param {Object} data - Kaydedilecek veri
                 */
                save(data) {
                    try {
                        const payload = {
                            timestamp: Date.now(),
                            data: data
                        };
                        localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify(payload));
                        console.log("Veri cache'e kaydedildi");
                    } catch (error) {
                        console.error("Cache kaydetme hatasƒ±:", error);
                    }
                },

                /**
                 * Cache'i temizler
                 */
                clear() {
                    localStorage.removeItem(CONFIG.CACHE_KEY);
                }
            };

            // ==================== API ƒ∞≈ûLEMLERƒ∞ ====================
            const ApiService = {
                /**
                 * Backend'den veri √ßeker
                 * @returns {Promise<Object>} API'den gelen veri
                 */
                async fetchData() {
                    try {
                        const response = await fetch(CONFIG.API_URL, { redirect: "follow" });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        console.log("Backend'den veri ba≈üarƒ±yla alƒ±ndƒ±");
                        return data;
                    } catch (error) {
                        console.error("API fetch hatasƒ±:", error);
                        throw error;
                    }
                },

                /**
                 * Yurt beƒüeni sayƒ±sƒ±nƒ± artƒ±rƒ±r
                 * @param {string} yurtAdi - Beƒüenilen yurt adƒ±
                 */
                async incrementLike(yurtAdi) {
                    try {
                        await fetch(CONFIG.API_URL, {
                            method: "POST",
                            mode: "no-cors",
                            cache: "no-cache",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                action: "artirTik",
                                yurtAdi: yurtAdi
                            })
                        });
                        console.log(`Beƒüeni g√∂nderildi: ${yurtAdi}`);
                    } catch (error) {
                        console.error("Beƒüeni g√∂nderme hatasƒ±:", error);
                    }
                }
            };

            // ==================== UI ƒ∞≈ûLEMLERƒ∞ ====================
            const UIManager = {
                /**
                 * Okul dropdown'unu doldurur
                 * @param {Array} okullar - Okul listesi
                 */
                renderOkulDropdown(okullar) {
                    const select = document.getElementById(CONFIG.SELECTORS.okulSecimi);
                    select.innerHTML = '<option value="">Bir okul se√ßin...</option>';

                    okullar.forEach(okul => {
                        const [id, ad] = okul;
                        if (id && ad) {
                            const option = document.createElement("option");
                            option.value = id.toString().trim();
                            option.text = ad.toString().trim();
                            select.appendChild(option);
                        }
                    });

                    console.log(`${okullar.length} okul dropdown'a eklendi`);
                },

                /**
                 * Se√ßilen okulun detaylarƒ±nƒ± g√∂sterir
                 * @param {Object} okul - Okul verisi
                 */
                renderOkulDetay(okul) {
                    const [, ad, harita, adres] = okul;
                    const detayDiv = document.getElementById(CONFIG.SELECTORS.okulDetay);

                    detayDiv.innerHTML = `
                        <div class="col-md-10 col-lg-8">
                            <div class="card shadow-lg border-primary mb-4 strong-shadow" style="border-left: 5px solid #007bff;">
                                <div class="card-body">
                                    <h4 class="fw-bold text-primary">üè´ ${ad}</h4>
                                    <p class="small text-muted mb-2">üìç ${adres}</p>
                                    <div style="height: 200px; border-radius: 10px; overflow: hidden;">
                                        <iframe
                                            src="${harita}"
                                            style="border:0; width:100%; height:400px;"
                                            loading="lazy"
                                            referrerpolicy="no-referrer-when-downgrade">
                                        </iframe>
                                    </div>
                                </div>
                            </div>
                            <h5 class="text-center mb-4 fw-bold">üëá Yakƒ±ndaki Yurtlar</h5>
                        </div>
                    `;
                },

                /**
                 * Yurt kartƒ± HTML'i olu≈üturur
                 * @param {Array} yurt - Yurt verisi
                 * @returns {string} HTML string
                 */
                createYurtCard(yurt) {
                    const [, ad, harita, adres, sorumlu, telefon] = yurt;
                    const temizTelefon = telefon.toString().replace(/\s/g, '');

                    return `
                        <div class="col-12 yurt-kart-sarmalayici">
                            <div class="card shadow-lg border-primary mb-4 strong-shadow" style="border-right: 5px solid #00ff33;">
                                <div class="row g-0">
                                    <div class="col-md-5">
                                        <div class="harita-konteyner">
                                            <iframe
                                                src="${harita}"
                                                style="border:0; width:100%; height:400px;"
                                                loading="lazy"
                                                referrerpolicy="no-referrer-when-downgrade">
                                            </iframe>
                                        </div>
                                    </div>
                                    <div class="col-md-7 d-flex align-items-center">
                                        <div class="card-body p-4 p-lg-5">
                                            <h3 class="fw-bold mb-3">${ad}</h3>
                                            <div class="mb-4">
                                                <p class="mb-2 text-muted"><strong>üìç Adres:</strong> ${adres}</p>
                                                <p class="mb-2 text-muted"><strong>üë§ Sorumlu:</strong> ${sorumlu}</p>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <a href="tel:${temizTelefon}" class="btn btn-success btn-lg px-4 shadow-sm">
                                                    üìû ${telefon}
                                                </a>
                                                <button onclick="OkulYurtApp.handleLikeClick('${ad}')" class="btn btn-outline-danger btn-sm">
                                                    ü§ç Beƒüen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                },

                /**
                 * "Yurt bulunamadƒ±" mesajƒ±nƒ± g√∂sterir
                 */
                renderBulunamadi() {
                    const listeDiv = document.getElementById(CONFIG.SELECTORS.yurtListesi);
                    listeDiv.innerHTML = `
                        <div class="col-12 text-center mt-5">
                            <div class="p-5 border rounded-3 bg-light shadow-sm">
                                <h1 class="display-1">üîé</h1>
                                <h4 class="fw-bold text-secondary">√úzg√ºn√ºz, Bu Okula Ait Yurt Bulunamadƒ±</h4>
                                <p class="text-muted">Se√ßtiƒüiniz okul i√ßin ≈üu an kayƒ±tlƒ± bir yurt verisi bulunmuyor.</p>
                            </div>
                        </div>
                    `;
                },

                /**
                 * UI'ƒ± temizler
                 */
                clearUI() {
                    document.getElementById(CONFIG.SELECTORS.okulDetay).innerHTML = "";
                    document.getElementById(CONFIG.SELECTORS.yurtListesi).innerHTML = "";
                }
            };

            // ==================== ƒ∞≈û MANTIKLARI ====================
            const BusinessLogic = {
                /**
                 * Se√ßilen okula ait yurtlarƒ± filtreler
                 * @param {string} okulID - Se√ßilen okul ID'si
                 * @returns {Array} E≈üle≈üen yurtlar
                 */
                filterYurtlarByOkul(okulID) {
                    if (!globalData || !globalData.yurtListesi) return [];

                    return globalData.yurtListesi.filter(yurt => {
                        const idListesi = (yurt[0] || "")
                            .toString()
                            .split(',')
                            .map(id => id.trim());

                        return idListesi.includes(okulID);
                    });
                },

                /**
                 * Okul ID'sine g√∂re okul verisini bulur
                 * @param {string} okulID - Aranacak okul ID'si
                 * @returns {Array|null} Okul verisi veya null
                 */
                findOkulById(okulID) {
                    if (!globalData || !globalData.okulListesi) return null;

                    return globalData.okulListesi.find(okul =>
                        okul[0].toString().trim() === okulID
                    );
                }
            };

            // ==================== PUBLIC API ====================
            return {
                /**
                 * Uygulamayƒ± ba≈ülatƒ±r
                 */
                async init() {
                    console.log("üöÄ Uygulama ba≈ülatƒ±lƒ±yor...");

                    // 1. Cache kontrol√º ve render
                    const cachedData = CacheManager.load();
                    if (cachedData) {
                        globalData = cachedData;
                        UIManager.renderOkulDropdown(cachedData.okulListesi);
                    }

                    // 2. Backend'den fresh data √ßek
                    try {
                        const freshData = await ApiService.fetchData();

                        // Veri deƒüi≈ümi≈üse g√ºncelle
                        if (JSON.stringify(cachedData) !== JSON.stringify(freshData)) {
                            console.log("‚úÖ Veri g√ºncellendi");
                            globalData = freshData;
                            CacheManager.save(freshData);
                            UIManager.renderOkulDropdown(freshData.okulListesi);
                        } else {
                            console.log("‚ÑπÔ∏è Veri deƒüi≈ümedi");
                        }
                    } catch (error) {
                        console.warn("‚ö†Ô∏è Backend'e ula≈üƒ±lamadƒ±, cache ile devam ediliyor", error);
                        if (!cachedData) {
                            alert("Veriler y√ºklenemedi. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.");
                        }
                    }
                },

                /**
                 * Se√ßilen okula g√∂re yurtlarƒ± listeler
                 */
                yurtlariListele() {
                    const secilenOkulID = document.getElementById(CONFIG.SELECTORS.okulSecimi).value;

                    UIManager.clearUI();

                    if (!secilenOkulID || !globalData) return;

                    console.log(`üîç Filtreleme ba≈ülatƒ±ldƒ±: ${secilenOkulID}`);

                    // Okul detayƒ±nƒ± g√∂ster
                    const okul = BusinessLogic.findOkulById(secilenOkulID);
                    if (okul) {
                        UIManager.renderOkulDetay(okul);
                    }

                    // Yurtlarƒ± filtrele ve g√∂ster
                    const esle≈°enYurtlar = BusinessLogic.filterYurtlarByOkul(secilenOkulID);

                    if (esle≈°enYurtlar.length === 0) {
                        UIManager.renderBulunamadi();
                        return;
                    }

                    const listeDiv = document.getElementById(CONFIG.SELECTORS.yurtListesi);
                    listeDiv.innerHTML = esle≈°enYurtlar
                        .map(yurt => UIManager.createYurtCard(yurt))
                        .join('');

                    console.log(`‚úÖ ${esle≈°enYurtlar.length} yurt listelendi`);
                },

                /**
                 * Beƒüen butonuna tƒ±klandƒ±ƒüƒ±nda √ßalƒ±≈üƒ±r
                 * @param {string} yurtAdi - Beƒüenilen yurt adƒ±
                 */
                handleLikeClick(yurtAdi) {
                    ApiService.incrementLike(yurtAdi);
                    // Kullanƒ±cƒ±ya g√∂rsel feedback verilebilir
                    console.log(`‚ù§Ô∏è Beƒüeni: ${yurtAdi}`);
                }
            };
        })();

        // ==================== UYGULAMA BA≈ûLATMA ====================
        window.addEventListener('DOMContentLoaded', () => {
            OkulYurtApp.init();
        });
    </script>
</body>

</html>